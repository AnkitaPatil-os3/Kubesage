stages:
  - build
  - push
  - docker-compose

variables:
  DOCKER_REGISTRY: "docker.io"
  DOCKER_USERNAME: "pranavshejul15"
  DOCKER_PASSWORD: "dckr_pat_q-pWLpGwf0lj-SaiNEbRYuRNjnk"

before_script:
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD $DOCKER_REGISTRY

# Build Images for all services

chat_service_build:
  stage: build
  script:
    - cd backend/chat_service
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/chat_service:latest .
  only:
    - devops-automation

k8sgpt_service_build:
  stage: build
  script:
    - cd backend/k8sgpt_service
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/k8sgpt_service:latest .
  only:
    - devops-automation

kubeconfig_service_build:
  stage: build
  script:
    - cd backend/kubeconfig_service
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/kubeconfig_service:latest .
  only:
    - devops-automation

user_service_build:
  stage: build
  script:
    - cd backend/user_service
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/user_service:latest .
  only:
    - devops-automation

frontend_build:
  stage: build
  script:
    - cd frontend
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/frontend:latest .
  only:
    - devops-automation

# Adding sleep to prevent race conditions between builds and pushes
sleep_before_push:
  stage: push
  script:
    - echo "Sleeping for 30 seconds to avoid race conditions."
    - sleep 30
  when: manual

# Push Images for all services (set to manual)

chat_service_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/chat_service:latest
  only:
    - devops-automation
  when: manual

k8sgpt_service_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/k8sgpt_service:latest
  only:
    - devops-automation
  when: manual

kubeconfig_service_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/kubeconfig_service:latest
  only:
    - devops-automation
  when: manual

user_service_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/user_service:latest
  only:
    - devops-automation
  when: manual

frontend_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/frontend:latest
  only:
    - devops-automation
  when: manual

# docker-compose:
#   stage: docker-compose
#   script:
#     - docker rm -f $(docker ps -aq) 
#     - docker-compose -f docker-compose.yml up -d
#   only:
#     - devops-automation
#   when: manual