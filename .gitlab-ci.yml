stages:
  - build
  - push

variables:
  DOCKER_REGISTRY: "docker.io"
  DOCKER_USERNAME: "pranavshejul15"
  DOCKER_PASSWORD: "dckr_pat_q-pWLpGwf0lj-SaiNEbRYuRNjnk"
  DOCKER_NAMESPACE: "kubesage"
  VERSION_PREFIX: "v1"  # This is where we can add versioning like v1, v2, etc.

before_script:
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD $DOCKER_REGISTRY

# Build Images for all services

chat_service_build:
  stage: build
  script:
    - cd backend/chat_service
    - VERSION=$VERSION_PREFIX-${CI_COMMIT_REF_NAME}  # Set version based on branch or tag
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/chat_service:$VERSION .
    - docker tag $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/chat_service:$VERSION $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/chat_service:latest
  only:
    - devops-automation

k8sgpt_service_build:
  stage: build
  script:
    - cd backend/k8sgpt_service
    - VERSION=$VERSION_PREFIX-${CI_COMMIT_REF_NAME}
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/k8sgpt_service:$VERSION .
    - docker tag $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/k8sgpt_service:$VERSION $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/k8sgpt_service:latest
  only:
    - devops-automation

kubeconfig_service_build:
  stage: build
  script:
    - cd backend/kubeconfig_service
    - VERSION=$VERSION_PREFIX-${CI_COMMIT_REF_NAME}
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/kubeconfig_service:$VERSION .
    - docker tag $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/kubeconfig_service:$VERSION $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/kubeconfig_service:latest
  only:
    - devops-automation

user_service_build:
  stage: build
  script:
    - cd backend/user_service
    - VERSION=$VERSION_PREFIX-${CI_COMMIT_REF_NAME}
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/user_service:$VERSION .
    - docker tag $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/user_service:$VERSION $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/user_service:latest
  only:
    - devops-automation

frontend_build:
  stage: build
  script:
    - cd frontend
    - VERSION=$VERSION_PREFIX-${CI_COMMIT_REF_NAME}
    - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/frontend:$VERSION .
    - docker tag $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/frontend:$VERSION $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/frontend:latest
  only:
    - devops-automation

# Adding sleep to prevent race conditions between builds and pushes
sleep_before_push:
  stage: push
  script:
    - echo "Sleeping for 30 seconds to avoid race conditions."
    - sleep 30
  when: manual

# Push Images for all services (set to manual)

chat_service_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/chat_service:$VERSION
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/chat_service:latest
  only:
    - devops-automation
  when: manual

k8sgpt_service_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/k8sgpt_service:$VERSION
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/k8sgpt_service:latest
  only:
    - devops-automation
  when: manual

kubeconfig_service_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/kubeconfig_service:$VERSION
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/kubeconfig_service:latest
  only:
    - devops-automation
  when: manual

user_service_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/user_service:$VERSION
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/user_service:latest
  only:
    - devops-automation
  when: manual

frontend_push:
  stage: push
  script:
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/frontend:$VERSION
    - docker push $DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_NAMESPACE/frontend:latest
  only:
    - devops-automation
  when: manual
