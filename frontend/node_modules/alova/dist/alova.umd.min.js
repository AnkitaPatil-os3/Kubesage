!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).alova={})}(this,(function(t){"use strict";const e="undefined",a=Promise,o=Object,s=RegExp,n=void 0,r=null,c=!0,i=!1,l=(t,e,a)=>t.then(e,a),h=(t,e)=>t.finally(e),u=(t,e,a)=>JSON.stringify(t,e,a),d=t=>o.keys(t),p=(t,e)=>t.forEach(e),f=(t,...e)=>t.push(...e),y=(t,e)=>t.map(e),m=(t,e)=>t.filter(e),g=t=>t.length,w=t=>Array.isArray(t),C=(t,e)=>delete t[e],b=t=>typeof t,v=typeof window===e&&(typeof process!==e?"function"==typeof process.cwd:typeof Deno!==e),S="memory",$="restore",k=()=>{},x=t=>t,E=t=>"function"===b(t),T=t=>o.prototype.toString.call(t),D=t=>"[object Object]"===T(t),H=(t,e)=>t instanceof e,M=t=>t?t.getTime():Date.now(),O=t=>t.context,R=t=>t.config,U=t=>t.options,j=t=>t.key,P=t=>{const{cacheFor:e}=R(t),a=t=>{return"number"!==b(e=t)||Number.isNaN(e)?M(t||n):M()+t;var e};let o=S,s=()=>0,r=i,c=n;const l=E(e);if(!l){let i=e;if(D(e)){const{mode:t=S,expire:a,tag:s}=e||{};o=t,r=t===$,c=s?s.toString():n,i=a}s=e=>a(E(i)?i({method:t,mode:e}):i)}return{f:e,c:l,e:s,m:o,s:r,t:c}},A=(t,...e)=>new t(...e),N=(t,e)=>"$a."+t+e,q=(t,e,a)=>{t=t.endsWith("/")?t.slice(0,-1):t,""!==e&&(e=e.match(/^(\/|https?:\/\/)/)?e:`/${e}`);const o=t+e,s=y(m(d(a),(t=>a[t]!==n)),(t=>`${t}=${a[t]}`)).join("&");return s?+o.includes("?")?`${o}&${s}`:`${o}?${s}`:o};class F extends Error{constructor(t,e,a){super(e+(a?`\n\nFor detailed: https://alova.js.org/error#${a}`:"")),this.name=`[alova${t?`/${t}`:""}]`}}const L=()=>{const t={};return{eventMap:t,on(e,a){const o=t[e]=t[e]||[];return f(o,a),()=>{t[e]=m(o,(t=>t!==a))}},off(e,a){const o=t[e];if(o)if(a){const t=o.indexOf(a);t>-1&&o.splice(t,1)}else delete t[e]},emit(e,a){const o=t[e]||[];return y(o,(t=>t(a)))}}};t.globalConfigMap={autoHitCache:"global",ssr:v};const B="color: black; font-size: 12px; font-weight: bolder";var I=(e,a,o,s)=>{const n=console,r=(...t)=>console.log(...t),{url:c}=a,i=o===$,l="[42m%s[49m",h="[32m%s[39m",u=` [HitCache]${c} `,d=()=>Array(g(u)+1).join("^");t.globalConfigMap.ssr?(r(l,u),r(h," Cache ",e),r(h," Mode  ",o),i&&r(h," Tag   ",s),r(h,d())):(n.groupCollapsed?n.groupCollapsed("%cHitCache","padding: 2px 6px; background: #c4fcd3; color: #53b56d;",c):r(l,u),r("%c[Cache]",B,e),r("%c[Mode]",B,o),i&&r("%c[Tag]",B,s),r("%c[Method]",B,a),n.groupEnd?n.groupEnd():r(h,d()))};const _=t=>`hss.${t}`,G="hsr.",J=t=>G+t,K="$$hsrs",z="__$<>$__",W=(t,e)=>{t[e]=0},Q=async(t,e,o,r,c,i,l)=>{if(r>M()&&o){const h=N(t,e);if(await c.set(h,m([o,r===1/0?n:r,l],Boolean)),i){const t={},e=[];p(i,(a=>{const o=H(a,s),n=o?a.source+(a.flags?z+a.flags:""):a;n&&(o&&!t[n]&&f(e,n),W(t,o?J(n):_(n)))}));const o=y(d(t),(async t=>{const e=await c.get(t)||{};W(e,h),await c.set(t,e)})),n=async()=>{if(g(e)){const t=await c.get(K)||[];f(t,...e),await c.set(K,t)}};await a.all([...o,n()])}}},V=async(t,e,a)=>{const o=N(t,e);await a.remove(o)},X=async(t,e,a,o)=>{const s=await a.get(N(t,e));if(s){const[n,r,c]=s;if(c===o&&(!r||r>M()))return s;await V(t,e,a)}},Y=async(t,e,a,o)=>{const s=await X(t,e,a,o);return s?s[0]:n},Z=async t=>a.all(t.map((t=>t.clear())));var tt=t=>{const{data:e,config:a}=t,s={...a},{headers:n={},params:r={}}=s,c=O(t);s.headers={...n},s.params={...r};return((t,...e)=>o.assign(t,...e))(A(nt,t.type,c,t.url,s,e),{...t,config:s})};const et=async e=>{const{autoHitCache:o}=t.globalConfigMap,{l1Cache:n,l2Cache:r}=O(e),c=j(e),{name:i}=R(e),l={global:[...gt,...wt],self:[n,r],close:[]}[o];l&&g(l)&&await a.all(y(l,(t=>(async(t,e,o)=>{const n=`${e}`,r={},c=_(t);let i;if(r[c]=await o.get(c),e){const t=_(n);r[t]=await o.get(t),i=await o.get(K);const e=[];i&&g(i)&&(p(i,(t=>{const[a,o]=t.split(z);A(s,a,o).test(n)&&f(e,t)})),await a.all(y(e,(async t=>{const e=J(t);r[e]=await o.get(e)}))))}const l=async t=>{try{await o.remove(t);for(const e in r){const a=r[e];a&&C(a,t)}}catch(t){}},h={};await a.all(y(d(r),(async t=>{const e=r[t];if(e){const t=[];for(const a in e)h[a]||(W(h,a),f(t,l(a)));await a.all(t)}})));const u=g(i||[]);await a.all(y(d(r),(async t=>{const e=r[t];e&&(g(d(e))?await o.set(t,e):(await o.remove(t),t.includes(G)&&i&&(i=m(i,(e=>J(e)!==t)))))}))),u!==g(i||[])&&await o.set(K,i)})(c,i,t))))},at={};function ot(t,e){let o,s=c;const u=A(a,(t=>{o=t}));return{abort:()=>{l(u,(t=>t&&t.abort()))},onDownload:t=>{l(u,(e=>e&&e.onDownload&&e.onDownload(t)))},onUpload:t=>{l(u,(e=>e&&e.onUpload&&e.onUpload(t)))},response:async()=>{const{beforeRequest:c=k,responded:u,requestAdapter:d,cacheLogger:p}=(t=>U(O(t)))(t),f=j(t),{s:y,t:m,m:g,e:w}=P(t),{id:b,l1Cache:v,l2Cache:M,snapshots:A}=O(t),{cacheFor:N}=R(t),{hitSource:F}=t;let L=await(E(N)?N():e?n:Y(b,f,v));if(g===$&&!L){const t=await X(b,f,M,m);if(t){const[e,a]=t;await Q(b,f,e,a,v,F),L=e}}const B=tt(t);await c(B);const{baseURL:_,url:G,type:J,data:K}=B,{params:z={},headers:W={},transform:V=x,shareRequest:Z}=R(B),ot=at[b]=at[b]||{};let st=ot[f],nt=x,rt=n,ct=k;if(E(u))nt=u;else if(D(u)){const{onSuccess:t,onError:e,onComplete:a}=u;nt=E(t)?t:nt,rt=E(e)?e:rt,ct=E(a)?a:ct}if(L!==n)return o(),(lt=I,E(it=p)?it:[i,r].includes(it)?k:lt)(L,B,g,m),ct(B),L;var it,lt;if(s=i,!Z||!st){const t=d({url:q(_,G,z),type:J,data:K,headers:W},B);st=ot[f]=t}o(st);const ht=async(e,o,s=true)=>{const n=await e,r=await V(n,o||{});A.save(t);try{await et(B)}catch(t){}const c=B.data,i=!c||!(t=>{const e=T(t);return/^\[object (Blob|FormData|ReadableStream|URLSearchParams)\]$/i.test(e)||H(t,ArrayBuffer)})(c);if(i&&s)try{await a.all([Q(b,f,r,w(S),v,F),y&&Q(b,f,r,w($),M,F,m)])}catch(t){}return r};return h(l(a.all([st.response(),st.headers()]),(([t,e])=>(C(ot,f),ht(nt(t,B),e))),(t=>{return C(ot,f),E(rt)?ht(rt(t,B),n,i):(e=t,a.reject(e));var e})),(()=>{ct(B)}))},fromCache:()=>s}}const st=(t,e)=>()=>{const a=e.indexOf(t);a>=0&&e.splice(a,1)};class nt{constructor(t,e,a,o,s){this.dhs=[],this.uhs=[],this.fromCache=n;const r=()=>{r.a()};r.a=k;const c=this,i=U(e);c.abort=r,c.baseURL=i.baseURL||"",c.url=a,c.type=t,c.context=e;const l={},h="cacheFor",u=D(i[h])?i[h][t]:n,d=o&&o.hitSource;p(["timeout","shareRequest"],(t=>{i[t]!==n&&(l[t]=i[t])})),u!==n&&(l[h]=u),d&&(c.hitSource=y(w(d)?d:[d],(t=>H(t,nt)?j(t):t)),C(o,"hitSource")),c.config={...l,headers:{},params:{},...o||{}},c.data=s,c.meta=o?o.meta:c.meta,c.key=c.generateKey()}onDownload(t){return f(this.dhs,t),st(t,this.dhs)}onUpload(t){return f(this.uhs,t),st(t,this.uhs)}send(t=i){const e=this,{response:a,onDownload:o,onUpload:s,abort:r,fromCache:c}=ot(e,t);return g(e.dhs)>0&&o(((t,a)=>p(e.dhs,(e=>e({loaded:t,total:a}))))),g(e.uhs)>0&&s(((t,a)=>p(e.uhs,(e=>e({loaded:t,total:a}))))),e.abort.a=r,e.fromCache=n,e.promise=l(a(),(t=>(e.fromCache=c(),t))),e.promise}setName(t){R(this).name=t}generateKey(){return(t=>{const{params:e,headers:a}=R(t);return u([t.type,t.url,e,t.data,a])})(this)}then(t,e){return l(this.send(),t,e)}catch(t){return((t,e)=>t.catch(e))(this.send(),t)}finally(t){return h(this.send(),t)}}const rt=((t="")=>(e,a,o)=>{if(!e)throw A(F,t,a,o)})(),ct="success",it=()=>(rt("undefined"!=typeof localStorage,"l2Cache is not defined."),localStorage),lt=()=>{const t=L(),e={set:(e,a)=>{it().setItem(e,u(a)),t.emit(ct,{type:"set",key:e,value:a,container:it()})},get:e=>{const a=it().getItem(e),o=a?(t=>JSON.parse(t))(a):a;return t.emit(ct,{type:"get",key:e,value:o,container:it()}),o},remove:e=>{it().removeItem(e),t.emit(ct,{type:"remove",key:e,container:it()})},clear:()=>{it().clear(),t.emit(ct,{type:"clear",key:"",container:it()})},emitter:t};return e},ht=Set;class ut{constructor(t){this.records={},this.occupy=0,rt(t>=0,"expected snapshots limit to be >= 0"),this.capacity=t}save(t){const{name:e}=R(t),{records:a,occupy:o,capacity:s}=this;if(e&&o<s){(a[e]=a[e]||A(ht)).add(t),this.occupy+=1}}match(t,e=!0){let a,o,n,r=t;D(t)&&(r=t.name,n=t.filter),H(r,s)?o=r:"string"===b(r)&&(a=r);const{records:c}=this;let i=A(ht);a?i=c[a]||i:o&&p(m(d(c),(t=>o.test(t))),(t=>{c[t].forEach((t=>i.add(t)))}));const l=E(n)?m([...i],n):[...i];return e?l:l[0]}}const dt="GET",pt={cacheFor:{[dt]:3e5},shareRequest:c,snapshots:1e3};let ft=0;class yt{constructor(t){var e,a;const o=this;o.id=(t.id||(ft+=1)).toString(),o.l1Cache=t.l1Cache||(()=>{let t={};const e=L(),a={set(a,o){t[a]=o,e.emit(ct,{type:"set",key:a,value:o,container:t})},get:a=>{const o=t[a];return e.emit(ct,{type:"get",key:a,value:o,container:t}),o},remove(a){C(t,a),e.emit(ct,{type:"remove",key:a,container:t})},clear:()=>{t={},e.emit(ct,{type:"clear",key:"",container:t})},emitter:e};return a})(),o.l2Cache=t.l2Cache||lt(),o.options={...pt,...t},o.snapshots=A(ut,null!==(a=null!==(e=t.snapshots)&&void 0!==e?e:pt.snapshots)&&void 0!==a?a:0)}Get(t,e){return A(nt,"GET",this,t,e)}Post(t,e,a){return A(nt,"POST",this,t,a,e)}Delete(t,e,a){return A(nt,"DELETE",this,t,a,e)}Put(t,e,a){return A(nt,"PUT",this,t,a,e)}Head(t,e){return A(nt,"HEAD",this,t,e)}Patch(t,e,a){return A(nt,"PATCH",this,t,a,e)}Options(t,e){return A(nt,"OPTIONS",this,t,e)}}let mt=n;const gt=[],wt=[];t.Method=nt,t.createAlova=t=>{const e=A(yt,t),a=e.options.statesHook;mt&&rt(mt===a,"expected to use the same `statesHook`"),mt=a;const{l1Cache:o,l2Cache:s}=e;return!gt.includes(o)&&f(gt,o),!wt.includes(s)&&f(wt,s),e},t.globalConfig=e=>{t.globalConfigMap={...t.globalConfigMap,...e}},t.hitCacheBySource=et,t.invalidateCache=async t=>{if(!t)return void await a.all([Z(gt),Z(wt)]);const e=(w(t)?t:[t]).map((t=>{const{id:e,l1Cache:o,l2Cache:s}=O(t),{c:n}=P(t);if(n)return;const r=j(t);return a.all([V(e,r,o),V(e,r,s)])}));await a.all(e)},t.promiseStatesHook=()=>(rt(!!mt,"`statesHook` is not set in alova instance"),mt),t.queryCache=async(t,{policy:e="all"}={})=>{if(t&&t.key){const{id:a,l1Cache:o,l2Cache:s}=O(t),r=j(t),{f:c,c:i,s:l,e:h,t:u}=P(t);if(i)return c();let d="l2"!==e?await Y(a,r,o):n;return"l2"===e?d=await Y(a,r,s,u):"all"!==e||d||l&&h($)>M()&&(d=await Y(a,r,s,u)),d}},t.setCache=async(t,e,{policy:o="all"}={})=>{const s=(w(t)?t:[t]).map((async t=>{const{hitSource:s}=t,{id:r,l1Cache:c,l2Cache:i}=O(t),l=j(t),{e:h,s:u,t:d,c:p}=P(t);if(p)return;let f=e;if(E(e)){let t="l2"!==o?await Y(r,l,c):n;if(("l2"===o||"all"===o&&!t&&u&&h($)>M())&&(t=await Y(r,l,i,d)),f=e(t),f===n)return}return a.all(["l2"!==o&&Q(r,l,f,h(S),c,s),"l2"===o||"all"===o&&u?Q(r,l,f,h($),i,s,d):n])}));return a.all(s)}}));
